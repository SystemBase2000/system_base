<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Time Clock App</title>
  <script type="module">
    // ===== IMPORT FIREBASE =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ====== ใส่ firebaseConfig ของคุณที่นี่ ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ===== INITIALIZE =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== กำหนดพิกัดออฟฟิศ =====
    const officeLat = 13.7563;  // เปลี่ยนเป็นพิกัดจริง
    const officeLng = 100.5018; // เปลี่ยนเป็นพิกัดจริง
    const maxDistance = 100; // เมตร

    // ===== ฟังก์ชันคำนวณระยะทาง =====
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a =
        Math.sin(Δφ/2) * Math.sin(Δφ/2) +
        Math.cos(φ1) * Math.cos(φ2) *
        Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // ===== ตรวจสอบสถานะ login =====
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("appSection").style.display = "block";
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("appSection").style.display = "none";
      }
    });

    // ===== สมัครสมาชิก =====
    window.register = async function() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      await createUserWithEmailAndPassword(auth, email, password);
      alert("สมัครสมาชิกสำเร็จ");
    }

    // ===== Login =====
    window.login = async function() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      await signInWithEmailAndPassword(auth, email, password);
      alert("เข้าสู่ระบบสำเร็จ");
    }

    // ===== Logout =====
    window.logout = async function() {
      await signOut(auth);
    }

    // ===== ปุ่มตอกบัตร =====
    window.checkIn = async function() {
      if (!navigator.geolocation) {
        alert("อุปกรณ์ไม่รองรับ GPS");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        const distance = getDistance(lat, lng, officeLat, officeLng);

        let locationType = "offsite";

        if (distance <= maxDistance) {
          locationType = "office";
        }

        await addDoc(collection(db, "timeclock"), {
          uid: auth.currentUser.uid,
          email: auth.currentUser.email,
          latitude: lat,
          longitude: lng,
          locationType: locationType,
          timestamp: serverTimestamp()
        });

        alert("บันทึกเวลาเรียบร้อย (" + locationType + ")");
      },
      () => {
        alert("ไม่สามารถดึงตำแหน่งได้");
      });
    }

  </script>
</head>

<body>
  <h2>Time Clock App</h2>

  <!-- LOGIN SECTION -->
  <div id="loginSection">
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
  </div>

  <!-- APP SECTION -->
  <div id="appSection" style="display:none;">
    <button onclick="checkIn()" style="font-size:20px; padding:20px;">
      ตอกบัตร
    </button>
    <br><br>
    <button onclick="logout()">Logout</button>
  </div>
</body>
</html>
